<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novagate ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        nav button {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        nav button:hover {
            color: #667eea;
        }

        nav button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        thead {
            background: #f8f8f8;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            color: #666;
            font-size: 14px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        tr:hover {
            background: #fafafa;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-primary {
            background: #e0e7ff;
            color: #667eea;
        }

        .badge-success {
            background: #dcfce7;
            color: #16a34a;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: #dcfce7;
            color: #16a34a;
            border-left: 4px solid #16a34a;
        }

        .alert-error {
            background: #fee2e2;
            color: #dc2626;
            border-left: 4px solid #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #667eea;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .permission-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .permission-item {
            background: #f0f0f0;
            padding: 12px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .permission-item button {
            background: none;
            border: none;
            color: #f56565;
            cursor: pointer;
            padding: 5px 10px;
            font-size: 16px;
            line-height: 1;
            flex-shrink: 0;
        }

        .permission-item button:hover {
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸš€ Novagate ç®¡ç†åå°</h1>
            <div class="subtitle">ç”¨æˆ· Â· æƒé™ Â· æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ</div>
        </div>
    </header>

    <div class="container">
        <nav>
            <button class="nav-btn active" data-section="dashboard">ğŸ“Š ä»ªè¡¨æ¿</button>
            <button class="nav-btn" data-section="users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</button>
            <button class="nav-btn" data-section="documents">ğŸ“„ æ–‡æ¡£ç®¡ç†</button>
            <button class="nav-btn" data-section="permissions">ğŸ”’ æƒé™ç®¡ç†</button>
            <button class="nav-btn" data-section="audit">ğŸ“‹ å®¡è®¡æ—¥å¿—</button>
        </nav>

        <!-- Dashboard -->
        <div id="dashboard" class="section active">
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-number" id="user-count">0</div>
                    <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="doc-count">0</div>
                    <div class="stat-label">æ€»æ–‡æ¡£æ•°</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" id="perm-count">0</div>
                    <div class="stat-label">æƒé™è§„åˆ™</div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Š å¿«é€Ÿæ¦‚è§ˆ</h2>
                <p>æ¬¢è¿ä½¿ç”¨ Novagate ç®¡ç†åå°ã€‚æ‚¨å¯ä»¥é€šè¿‡æ­¤ç³»ç»Ÿç®¡ç†ç”¨æˆ·ã€æ–‡æ¡£å’Œæƒé™ã€‚</p>
                <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 4px; font-size: 14px; line-height: 1.6;">
                    <strong>ç½‘å…³åœ°å€ï¼š</strong> localhost:9000<br>
                    <strong>å‘é‡æ•°æ®åº“ï¼š</strong> Milvus @ localhost:19530<br>
                    <strong>æƒé™å­˜å‚¨ï¼š</strong> Redis @ localhost:6379<br>
                    <strong>æ¶ˆæ¯é˜Ÿåˆ—ï¼š</strong> Kafka @ localhost:9092
                </div>
            </div>
        </div>

        <!-- Users -->
        <div id="users" class="section">
            <div class="card">
                <h2>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h2>
                <div id="user-alert"></div>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <button class="btn-primary" onclick="openUserModal()">+ æ–°å¢ç”¨æˆ·</button>
                    <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;" onkeyup="loadUsers()">
                </div>

                <div id="users-container" class="empty-state">
                    <div class="loading"></div> åŠ è½½ä¸­...
                </div>
                
                <div id="usersPagination" style="margin-top: 20px; display: none; text-align: center;">
                    <button class="btn-secondary" onclick="previousUserPage()" style="margin-right: 10px;">â† ä¸Šä¸€é¡µ</button>
                    <span id="userPageInfo">ç¬¬ 1 é¡µ</span>
                    <button class="btn-secondary" onclick="nextUserPage()" style="margin-left: 10px;">ä¸‹ä¸€é¡µ â†’</button>
                </div>
            </div>
        </div>

        <!-- Documents -->
        <div id="documents" class="section">
            <div class="card">
                <h2>ğŸ“„ æ–‡æ¡£ç®¡ç†</h2>
                <div id="doc-alert"></div>
                
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <button class="btn-primary" onclick="openDocModal()">+ æ–°å¢æ–‡æ¡£</button>
                    <input type="text" id="docSearch" placeholder="æœç´¢æ–‡æ¡£..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;" onkeyup="loadDocuments()">
                </div>

                <div id="docs-container" class="empty-state">
                    <div class="loading"></div> åŠ è½½ä¸­...
                </div>

                <div id="docsPagination" style="margin-top: 20px; display: none; text-align: center;">
                    <button class="btn-secondary" onclick="previousDocPage()" style="margin-right: 10px;">â† ä¸Šä¸€é¡µ</button>
                    <span id="docPageInfo">ç¬¬ 1 é¡µ</span>
                    <button class="btn-secondary" onclick="nextDocPage()" style="margin-left: 10px;">ä¸‹ä¸€é¡µ â†’</button>
                </div>
            </div>
        </div>

        <!-- Permissions -->
        <div id="permissions" class="section">
            <div class="card">
                <h2>ğŸ”’ æƒé™ç®¡ç†</h2>
                <div id="perm-alert"></div>

                <div style="margin-bottom: 20px;">
                    <button class="btn-primary" onclick="openPermModal()">+ æˆäºˆæƒé™</button>
                </div>

                <div id="perms-container" class="empty-state">
                    <div class="loading"></div> åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <!-- Audit Logs -->
        <div id="audit" class="section">
            <div class="card">
                <h2>ğŸ“‹ å®¡è®¡æ—¥å¿—</h2>
                
                <div id="audit-container" class="empty-state">
                    <div class="empty-state-icon">ğŸ“</div>
                    <p>æš‚æ— å®¡è®¡æ—¥å¿—</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°å¢ç”¨æˆ·</div>
            <div>
                <div class="form-group">
                    <label>ç”¨æˆ· ID</label>
                    <input type="text" id="userId" placeholder="e.g., user-001">
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="userName" placeholder="e.g., Alice">
                </div>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="userEmail" placeholder="alice@example.com">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeUserModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="createUser()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="docModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°å¢æ–‡æ¡£</div>
            <div>
                <div class="form-group">
                    <label>æ–‡æ¡£ ID</label>
                    <input type="text" id="docId" placeholder="e.g., doc-001">
                </div>
                <div class="form-group">
                    <label>æ ‡é¢˜</label>
                    <input type="text" id="docTitle" placeholder="æ–‡æ¡£æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <input type="text" id="docCategory" placeholder="e.g., programming">
                </div>
                <div class="form-group">
                    <label>æ‰€æœ‰è€…</label>
                    <input type="text" id="docOwner" placeholder="e.g., user-001">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDocModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="createDocument()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- Permission Modal -->
    <div id="permModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æˆäºˆæƒé™</div>
            <div>
                <div class="form-group">
                    <label>ç”¨æˆ·</label>
                    <select id="permUser">
                        <option value="">é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ–‡æ¡£</label>
                    <select id="permDoc">
                        <option value="">é€‰æ‹©æ–‡æ¡£</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç§Ÿæˆ· ID</label>
                    <input type="text" id="permTenant" value="tenant-001" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePermModal()">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="grantPermission()">æˆäºˆ</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const section = btn.dataset.section;
                switchSection(section, btn);
            });
        });

        function switchSection(section, clickedButton) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(section).classList.add('active');
            if (clickedButton) clickedButton.classList.add('active');
            
            if (section === 'users') loadUsers();
            else if (section === 'documents') loadDocuments();
            else if (section === 'permissions') loadPermissions();
            else if (section === 'dashboard') loadDashboard();
            else if (section === 'audit') loadAuditLogs();
        }

        // API Calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (data) options.body = JSON.stringify(data);
                
                // Add timestamp to prevent caching for GET requests
                let url = `${API_BASE}${endpoint}`;
                if (method === 'GET') {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}t=${Date.now()}`;
                }
                
                const response = await fetch(url, options);
                if (!response.ok) {
                    console.error(`HTTP Error: ${response.status} ${response.statusText}`);
                    return { code: response.status, message: `HTTP ${response.status}` };
                }
                const result = await response.json();
                console.log('API Response:', url, result);
                return result;
            } catch (error) {
                console.error('API Error:', error);
                return { code: 500, message: error.message };
            }
        }

        // Dashboard
        async function loadDashboard() {
            const users = await apiCall('/users');
            const docs = await apiCall('/documents');
            const perms = await apiCall('/permissions');

            document.getElementById('user-count').textContent = (users && users.data) ? users.data.length : 0;
            document.getElementById('doc-count').textContent = (docs && docs.data) ? docs.data.length : 0;
            document.getElementById('perm-count').textContent = (perms && perms.data) ? perms.data.length : 0;
        }

        // Global pagination state
        let userState = { page: 1, pageSize: 10, total: 0, totalPage: 0 };
        let docState = { page: 1, pageSize: 10, total: 0, totalPage: 0 };

        // Users
        async function loadUsers() {
            const container = document.getElementById('users-container');
            const pagination = document.getElementById('usersPagination');
            
            // Show loading state
            container.innerHTML = '<div class="empty-state"><div class="loading"></div><p>åŠ è½½ä¸­...</p></div>';
            pagination.style.display = 'none';
            
            try {
                const keyword = document.getElementById('userSearch').value;
                const result = await apiCall(`/users?keyword=${encodeURIComponent(keyword)}&page=${userState.page}&page_size=${userState.pageSize}`);
                
                console.log('loadUsers result:', result);
                
                // Check for errors
                if (!result || result.code !== 200) {
                    const errorMsg = result?.message || 'ç½‘ç»œé”™è¯¯';
                    console.error('API error:', errorMsg);
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + errorMsg + '</p></div>';
                    pagination.style.display = 'none';
                    return;
                }
                
                if (!result.data || !result.data.data || result.data.data.length === 0) {
                    console.log('No users found');
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¤</div><p>æš‚æ— ç”¨æˆ·</p></div>';
                    pagination.style.display = 'none';
                    return;
                }

                // Save pagination state
                userState.page = result.data.page || 1;
                userState.pageSize = result.data.page_size || 10;
                userState.total = result.data.total || 0;
                userState.totalPage = result.data.total_page || 1;

                let html = '<table><thead><tr><th>ç”¨æˆ· ID</th><th>ç”¨æˆ·å</th><th>é‚®ç®±</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                result.data.data.forEach(user => {
                    const formattedDate = formatDate(user.created_at);
                    html += `<tr>
                        <td><span class="badge badge-primary">${user.id || '-'}</span></td>
                        <td>${user.name || '-'}</td>
                        <td>${user.email || '-'}</td>
                        <td>${formattedDate}</td>
                        <td><button class="btn-danger" style="padding: 6px 12px; font-size: 13px;" onclick="deleteUser('${user.id}')">åˆ é™¤</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

                // Show pagination if needed
                if (userState.totalPage > 1) {
                    pagination.style.display = 'block';
                    document.getElementById('userPageInfo').textContent = `ç¬¬ ${userState.page} / ${userState.totalPage} é¡µ`;
                } else {
                    pagination.style.display = 'none';
                }
                console.log('Users loaded successfully');
            } catch (error) {
                console.error('loadUsers error:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
                pagination.style.display = 'none';
            }
        }

        function previousUserPage() {
            if (userState.page > 1) {
                userState.page--;
                loadUsers();
            }
        }

        function nextUserPage() {
            if (userState.page < userState.totalPage) {
                userState.page++;
                loadUsers();
            }
        }

        async function createUser() {
            const id = document.getElementById('userId').value;
            const name = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;

            if (!id || !name || !email) {
                showAlert('user-alert', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            const result = await apiCall('/users', 'POST', { id, name, email });
            if (result.code === 200) {
                closeUserModal();
                showAlert('user-alert', 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                loadUsers();
            } else {
                showAlert('user-alert', result.message, 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ç”¨æˆ· ${id}?`)) return;
            const result = await apiCall('/users', 'DELETE', { id });
            if (result.code === 200) {
                showAlert('user-alert', 'ç”¨æˆ·å·²åˆ é™¤', 'success');
                loadUsers();
            } else {
                showAlert('user-alert', result.message, 'error');
            }
        }

        // Documents
        async function loadDocuments() {
            const container = document.getElementById('docs-container');
            const pagination = document.getElementById('docsPagination');
            
            // Show loading state
            container.innerHTML = '<div class="empty-state"><div class="loading"></div><p>åŠ è½½ä¸­...</p></div>';
            pagination.style.display = 'none';
            
            try {
                const keyword = document.getElementById('docSearch').value;
                const result = await apiCall(`/documents?keyword=${encodeURIComponent(keyword)}&page=${docState.page}&page_size=${docState.pageSize}`);
                
                console.log('loadDocuments result:', result);
                
                // Check for errors
                if (!result || result.code !== 200) {
                    const errorMsg = result?.message || 'ç½‘ç»œé”™è¯¯';
                    console.error('API error:', errorMsg);
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + errorMsg + '</p></div>';
                    pagination.style.display = 'none';
                    return;
                }
                
                if (!result.data || !result.data.data || result.data.data.length === 0) {
                    console.log('No documents found');
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“„</div><p>æš‚æ— æ–‡æ¡£</p></div>';
                    pagination.style.display = 'none';
                    return;
                }

                // Save pagination state
                docState.page = result.data.page || 1;
                docState.pageSize = result.data.page_size || 10;
                docState.total = result.data.total || 0;
                docState.totalPage = result.data.total_page || 1;

                let html = '<table><thead><tr><th>æ–‡æ¡£ ID</th><th>æ ‡é¢˜</th><th>åˆ†ç±»</th><th>æ‰€æœ‰è€…</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                result.data.data.forEach(doc => {
                    const formattedDate = formatDate(doc.created_at);
                    html += `<tr>
                        <td><span class="badge badge-success">${doc.id || '-'}</span></td>
                        <td>${doc.title || '-'}</td>
                        <td>${doc.category || '-'}</td>
                        <td>${doc.owner_id || '-'}</td>
                        <td>${formattedDate}</td>
                        <td><button class="btn-danger" style="padding: 6px 12px; font-size: 13px;" onclick="deleteDocument('${doc.id}')">åˆ é™¤</button></td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

                // Show pagination if needed
                if (docState.totalPage > 1) {
                    pagination.style.display = 'block';
                    document.getElementById('docPageInfo').textContent = `ç¬¬ ${docState.page} / ${docState.totalPage} é¡µ`;
                } else {
                    pagination.style.display = 'none';
                }
                console.log('Documents loaded successfully');
            } catch (error) {
                console.error('loadDocuments error:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
                pagination.style.display = 'none';
            }
        }

        function previousDocPage() {
            if (docState.page > 1) {
                docState.page--;
                loadDocuments();
            }
        }

        function nextDocPage() {
            if (docState.page < docState.totalPage) {
                docState.page++;
                loadDocuments();
            }
        }

        async function createDocument() {
            const id = document.getElementById('docId').value;
            const title = document.getElementById('docTitle').value;
            const category = document.getElementById('docCategory').value;
            const owner_id = document.getElementById('docOwner').value;

            if (!id || !title || !category || !owner_id) {
                showAlert('doc-alert', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            const result = await apiCall('/documents', 'POST', { id, title, category, owner_id });
            if (result.code === 200) {
                closeDocModal();
                showAlert('doc-alert', 'æ–‡æ¡£åˆ›å»ºæˆåŠŸ', 'success');
                loadDocuments();
            } else {
                showAlert('doc-alert', result.message, 'error');
            }
        }

        async function deleteDocument(id) {
            if (!confirm(`ç¡®è®¤åˆ é™¤æ–‡æ¡£ ${id}?`)) return;
            const result = await apiCall('/documents', 'DELETE', { id });
            if (result.code === 200) {
                showAlert('doc-alert', 'æ–‡æ¡£å·²åˆ é™¤', 'success');
                loadDocuments();
            } else {
                showAlert('doc-alert', result.message, 'error');
            }
        }

        // Permissions
        async function loadPermissions() {
            const container = document.getElementById('perms-container');
            
            // Show loading state
            container.innerHTML = '<div class="empty-state"><div class="loading"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await apiCall('/permissions?tenant_id=tenant-001');
                
                console.log('loadPermissions result:', result);
                
                // Check for errors
                if (!result || result.code !== 200) {
                    const errorMsg = result?.message || 'ç½‘ç»œé”™è¯¯';
                    console.error('API error:', errorMsg);
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + errorMsg + '</p></div>';
                    return;
                }
                
                if (!result.data || result.data.length === 0) {
                    console.log('No permissions found');
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”’</div><p>æš‚æ— æƒé™è§„åˆ™</p></div>';
                    return;
                }

                let html = '<div>';
                result.data.forEach(perm => {
                    html += `<div class="card" style="margin-bottom: 15px;">
                        <strong>ç”¨æˆ·: ${perm.user_id || '-'}</strong><br>
                        <small>ç§Ÿæˆ·: ${perm.tenant_id || '-'}</small>
                        <div class="permission-list">`;
                    
                    // æ˜¾ç¤ºå®Œæ•´çš„æ–‡æ¡£ä¿¡æ¯
                    if (perm.documents && perm.documents.length > 0) {
                        perm.documents.forEach(doc => {
                            html += `<div class="permission-item">
                                <div style="flex: 1;">
                                    <strong>${doc.title || '-'}</strong>
                                    <div style="font-size: 12px; color: #999; margin-top: 2px;">
                                        ID: ${doc.id || '-'} | åˆ†ç±»: ${doc.category || '-'} | æ‰€æœ‰è€…: ${doc.owner_id || '-'}
                                    </div>
                                </div>
                                <button onclick="revokePermission('${perm.tenant_id}', '${perm.user_id}', '${doc.id}')">âœ•</button>
                            </div>`;
                        });
                    } else if (perm.doc_ids && perm.doc_ids.length > 0) {
                        // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœæ²¡æœ‰ documents å­—æ®µï¼Œæ˜¾ç¤º doc_ids
                        perm.doc_ids.forEach(doc_id => {
                            html += `<div class="permission-item">
                                <span>${doc_id}</span>
                                <button onclick="revokePermission('${perm.tenant_id}', '${perm.user_id}', '${doc_id}')">âœ•</button>
                            </div>`;
                        });
                    }
                    
                    html += `</div></div>`;
                });
                html += '</div>';
                container.innerHTML = html;
                console.log('Permissions loaded successfully');
            } catch (error) {
                console.error('loadPermissions error:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
            }
        }

        async function grantPermission() {
            const tenant_id = document.getElementById('permTenant').value;
            const user_id = document.getElementById('permUser').value;
            const doc_id = document.getElementById('permDoc').value;

            if (!user_id || !doc_id) {
                showAlert('perm-alert', 'è¯·é€‰æ‹©ç”¨æˆ·å’Œæ–‡æ¡£', 'error');
                return;
            }

            const result = await apiCall('/permissions', 'POST', { tenant_id, user_id, doc_id });
            if (result.code === 200) {
                closePermModal();
                showAlert('perm-alert', 'æƒé™å·²æˆäºˆ', 'success');
                loadPermissions();
            } else {
                showAlert('perm-alert', result.message, 'error');
            }
        }

        async function revokePermission(tenant_id, user_id, doc_id) {
            if (!confirm(`æ’¤é”€ ${user_id} å¯¹ ${doc_id} çš„è®¿é—®æƒé™?`)) return;
            const result = await apiCall('/permissions', 'DELETE', { tenant_id, user_id, doc_id });
            if (result.code === 200) {
                showAlert('perm-alert', 'æƒé™å·²æ’¤é”€', 'success');
                loadPermissions();
            } else {
                showAlert('perm-alert', result.message, 'error');
            }
        }

        // Audit Logs
        async function loadAuditLogs() {
            const container = document.getElementById('audit-container');
            
            // Show loading state
            container.innerHTML = '<div class="empty-state"><div class="loading"></div><p>åŠ è½½ä¸­...</p></div>';
            
            try {
                const result = await apiCall('/audit-logs');
                
                console.log('loadAuditLogs result:', result);
                
                // Check for errors
                if (!result || result.code !== 200) {
                    const errorMsg = result?.message || 'ç½‘ç»œé”™è¯¯';
                    console.error('API error:', errorMsg);
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + errorMsg + '</p></div>';
                    return;
                }
                
                if (!result.data || !result.data.logs || result.data.logs.length === 0) {
                    console.log('No audit logs found');
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><p>æš‚æ— å®¡è®¡æ—¥å¿—</p></div>';
                    return;
                }

                let html = '<table><thead><tr><th>æ—¶é—´</th><th>æ“ä½œ</th><th>ç›®æ ‡</th><th>è¯¦æƒ…</th></tr></thead><tbody>';
                result.data.logs.forEach(log => {
                    const formattedDate = formatDate(log.timestamp);
                    html += `<tr>
                        <td><small>${formattedDate}</small></td>
                        <td><span class="badge badge-primary">${log.action || '-'}</span></td>
                        <td>${log.target || '-'}</td>
                        <td>${log.message || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
                console.log('Audit logs loaded successfully');
            } catch (error) {
                console.error('loadAuditLogs error:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥: ' + error.message + '</p></div>';
            }
        }

        // Modals
        function openUserModal() { document.getElementById('userModal').classList.add('active'); }
        function closeUserModal() { document.getElementById('userModal').classList.remove('active'); clearForm(['userId', 'userName', 'userEmail']); }
        function openDocModal() { document.getElementById('docModal').classList.add('active'); }
        function closeDocModal() { document.getElementById('docModal').classList.remove('active'); clearForm(['docId', 'docTitle', 'docCategory', 'docOwner']); }
        async function openPermModal() { 
            document.getElementById('permModal').classList.add('active');

            // åŠ è½½ç”¨æˆ·åˆ—è¡¨
            const userSelect = document.getElementById('permUser');
            userSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';
            const usersResp = await apiCall('/users');
            if (usersResp && usersResp.data && usersResp.data.data) {
                usersResp.data.data.forEach(u => {
                    const option = document.createElement('option');
                    option.value = u.id;
                    option.textContent = `${u.id} - ${u.name}`;
                    userSelect.appendChild(option);
                });
            }

            // åŠ è½½æ–‡æ¡£åˆ—è¡¨
            const docSelect = document.getElementById('permDoc');
            docSelect.innerHTML = '<option value="">é€‰æ‹©æ–‡æ¡£</option>';
            const docsResp = await apiCall('/documents');
            if (docsResp && docsResp.data && docsResp.data.data) {
                docsResp.data.data.forEach(d => {
                    const option = document.createElement('option');
                    option.value = d.id;
                    option.textContent = `${d.id} - ${d.title}`;
                    docSelect.appendChild(option);
                });
            }
        }
        function closePermModal() { document.getElementById('permModal').classList.remove('active'); }

        // Helpers
        function clearForm(ids) {
            ids.forEach(id => document.getElementById(id).value = '');
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alert.innerHTML = '', 4000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            const ms = String(d.getMilliseconds()).padStart(3, '0');
            return d.toLocaleString('zh-CN', { hour12: false }) + '.' + ms;
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>
