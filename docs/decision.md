# 架构决策记录（decision）

本文档用于记录本项目中的关键架构与协议设计决策。
每一条决策都明确说明了当时的背景、最终选择以及权衡结果，
用于后续维护、评审与复盘。

---

## ADR-0001：在 TCP 字节流之上引入应用层 Frame

### 状态
已采纳（Accepted）

### 背景（Context）
TCP 提供的是可靠的字节流传输，但不保留消息边界。
一次读取操作可能返回半个消息，也可能包含多个消息。
系统需要一种明确的方式来划分和重组逻辑上的数据单元，
以支持协议解析、资源控制和请求路由。

### 决策（Decision）
在 TCP 之上定义应用层 Frame 抽象。
每个 Frame 包含显式的长度字段和负载数据，
用于在任意 TCP 读取边界下重建完整的协议单元。

### 结果与影响（Consequences）
- 实现确定性的协议解析，避免粘包和拆包问题。
- 为内存统计、限流和连接级资源控制提供最小处理单元。
- 引入了额外的协议头和解析逻辑，增加了一定实现复杂度。

### 备选方案（Alternatives Considered）
- 依赖固定大小读取（因 TCP 分片不可控而否决）。
- 使用分隔符协议（因扫描成本和歧义问题而否决）。

---

## ADR-0002：分离传输层 Frame 与语义层 Message

### 状态
已采纳（Accepted）

### 背景（Context）
早期设计中，传输解析逻辑与业务语义耦合在一起，
导致协议难以演进、代码职责不清晰。
传输层关注的是字节边界与缓冲管理，
而业务层关注的是请求、响应及其语义。

### 决策（Decision）
在 Frame 之上引入 Message 层。
Frame 仅负责传输边界与数据承载，
Message 负责表达请求 / 响应等语义概念。

### 结果与影响（Consequences）
- 明确区分传输层与业务层职责，降低耦合度。
- 简化业务处理逻辑，提升协议可扩展性。
- 每次请求增加一次 Message 的编码与解码成本。

### 备选方案（Alternatives Considered）
- 直接在 Frame 中承载业务语义（因耦合过高而否决）。

---

## ADR-0003：使用显式 Request ID 进行请求-响应关联

### 状态
已采纳（Accepted）

### 背景（Context）
系统支持在同一连接上并发处理多个请求。
仅依赖请求与响应的顺序无法满足并发与流水线处理需求，
需要一种显式的关联机制。

### 决策（Decision）
在 Message 头部中引入 Request ID 字段，
用于明确标识请求与对应响应之间的关系。

### 结果与影响（Consequences）
- 支持连接内并发请求与异步响应。
- 为未来的超时、取消和重试机制打下基础。
- 增加了消息头大小及一定的状态管理复杂度。

### 备选方案（Alternatives Considered）
- 强制严格的请求-响应顺序（因扩展性受限而否决）。

---

## ADR-0004：在连接级与 Frame 级进行内存控制

### 状态
已采纳（Accepted）

### 背景（Context）
在高并发或异常输入场景下，
如果对连接缓冲和单次消息大小不加限制，
可能导致内存无限增长，最终引发 OOM。

### 决策（Decision）
在连接级别设置内存配额，
并在 Frame 解码阶段限制单个 Frame 的最大大小，
在超出限制时直接拒绝处理。

### 结果与影响（Consequences）
- 防止单连接或异常流量导致的内存耗尽。
- 提高系统整体稳定性与可预期性。
- 需要谨慎配置阈值，避免对正常请求造成误伤。

### 备选方案（Alternatives Considered）
- 仅依赖全局内存限制（因缺乏连接隔离而否决）。

---
